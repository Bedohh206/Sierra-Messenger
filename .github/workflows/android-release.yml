name: Build Release AAB

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      # Ensure Gradle wrapper can run on Linux (fixes exit code 126)
      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Decode keystore from secret
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          mkdir -p keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > keystore/my-release-key.jks
          ls -la keystore

      - name: Write keystore.properties
        run: |
          mkdir -p keystore
          echo "storeFile=keystore/my-release-key.jks" > keystore.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "keystore.properties written"

      # Build the signed release bundle
      - name: Build Release AAB
        run: ./gradlew :app:bundleRelease --no-daemon --stacktrace

      # Always upload outputs for debugging
      - name: Timestamp-sign AAB with jarsigner
        if: success()
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "Signing AAB with jarsigner (timestamping)"
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore keystore/my-release-key.jks \
            -storepass "$KEYSTORE_PASSWORD" -keypass "$KEY_PASSWORD" \
            -tsa http://timestamp.digicert.com \
            app/build/outputs/bundle/release/app-release.aab "$KEY_ALIAS"
          echo "Verify signed AAB"
          jarsigner -verify -verbose -certs app/build/outputs/bundle/release/app-release.aab || true
      - name: Upload build outputs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            app/build/outputs/**
            app/build/reports/**
          if-no-files-found: ignore

      # Upload AAB (if it exists)
      - name: Upload AAB artifact (if present)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/app-release.aab
          if-no-files-found: ignore

      # Get versionName safely
      - name: Get versionName
        id: get_version
        if: success()
        shell: bash
        run: |
          if [ -f "app/build.gradle.kts" ]; then
            VERSION_NAME=$(grep -Po 'versionName\s*=\s*"(.*?)"' app/build.gradle.kts | sed -E 's/.*"(.+)".*/\1/' | head -n 1)
          elif [ -f "app/build.gradle" ]; then
            VERSION_NAME=$(grep -Po 'versionName\s+"(.*?)"' app/build.gradle | sed -E 's/.*"(.+)".*/\1/' | head -n 1)
          else
            VERSION_NAME=""
          fi

          if [ -z "$VERSION_NAME" ]; then
            VERSION_NAME="unknown"
          fi

          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "Detected VERSION_NAME=$VERSION_NAME"

      - name: Set release metadata
        if: success()
        shell: bash
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Create GitHub Release
        id: create_release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tag_name: v${{ env.VERSION_NAME }}-${{ env.SHORT_SHA }}-build-${{ github.run_number }}
          release_name: Release ${{ env.VERSION_NAME }} (${{ env.SHORT_SHA }} build ${{ github.run_number }})
          body: |
            Automated build ${{ github.run_number }}
            - Version: ${{ env.VERSION_NAME }}
            - Commit: ${{ env.SHORT_SHA }}
            - Branch: ${{ env.BRANCH }}
          draft: false
          prerelease: true

      - name: Upload AAB to Release
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: app/build/outputs/bundle/release/app-release.aab
          asset_name: app-release.aab
          asset_content_type: application/octet-stream
